<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LocalVision 상태표 (TV + ADMIN)</title>
  <style>
    body{font-family:system-ui,-apple-system,"Pretendard","Noto Sans KR",Arial,sans-serif;margin:16px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{padding:10px 12px;font-size:14px}
    input[type="text"]{width:520px;max-width:92vw}
    button{cursor:pointer}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .on{background:#e7fff0;color:#0a7a35;border:1px solid #0a7a35}
    .off{background:#ffecec;color:#b50000;border:1px solid #b50000}
    .warn{background:#fff7e6;color:#9a6b00;border:1px solid #9a6b00}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #ddd;padding:10px 8px;text-align:left;vertical-align:top;font-size:13px}
    th{background:#f6f6f6;position:sticky;top:0;z-index:1}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .small{color:#666;font-size:12px}
    .right{text-align:right}
  </style>
</head>
<body>
  <h2>상태표 (stores.json 기준 + TV/ADMIN 동시)</h2>

  <div class="row">
    <label>상태 Worker</label>
    <input id="apiBase" type="text" value="https://lv-status-api.kiklekidz.workers.dev"/>
    <label>검색</label>
    <input id="q" type="text" placeholder="store 또는 이름 검색"/>
    <button id="refreshBtn">새로고침</button>
    <button onclick="location.href='./'">런처로</button>
  </div>

  <div id="meta" style="margin-top:10px;"></div>

  <table>
    <thead>
      <tr>
        <th style="width:160px;">name</th>
        <th style="width:140px;">store</th>
        <th style="width:140px;">TV</th>
        <th style="width:80px;">age</th>
        <th style="width:140px;">ADMIN</th>
        <th style="width:80px;">age</th>
        <th style="width:130px;">TV ip/colo</th>
        <th style="width:130px;">ADMIN ip/colo</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const apiBaseEl = $("apiBase");
  const qEl = $("q");
  const metaEl = $("meta");
  const tbodyEl = $("tbody");

  const esc = (s)=>String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  const pill = (t,cls)=>`<span class="pill ${cls}">${t}</span>`;
  const normBase = (v)=>String(v||'').trim().replace(/\/+$/,'');
  const storeFromUrl = (url)=>{ try{ const u=new URL(url, location.href); return (u.searchParams.get('store')||'').trim().toLowerCase(); }catch(e){return '';} };
  const toMs = (x)=>{ const n=Number(x); return Number.isFinite(n)?n:null; };

  async function loadStores(){
    const res = await fetch(`./stores.json?v=${Date.now()}`, { cache:'no-store' });
    if(!res.ok) throw new Error('stores.json 로드 실패: '+res.status);
    const stores = await res.json();
    if(!Array.isArray(stores)) throw new Error('stores.json 형식 오류');
    return stores.map(s => ({ name:s.name||'', url:s.url, store:(s.store||storeFromUrl(s.url)||'').toLowerCase() }));
  }

  async function fetchStatus(role, base){
    const url = `${base}/status/all?role=${encodeURIComponent(role)}&t=${Date.now()}`;
    try{
      const res = await fetch(url, { cache:'no-store' });
      const data = await res.json().catch(()=>null);
      if(!data || data.ok !== true) return { ok:false, role, url, ttlSec:120, items:[] };
      return { ok:true, role, url, ttlSec:Number(data.ttlSec||120), items:Array.isArray(data.items)?data.items:[] };
    }catch(e){
      return { ok:false, role, url, ttlSec:120, items:[] };
    }
  }

  function mapByStore(items){
    const m = new Map();
    for(const it of (items||[])){
      const store = String(it.store||'').trim().toLowerCase();
      if(store) m.set(store, it);
    }
    return m;
  }

  function calc(lastSeenMs, ttlSec){
    if(!lastSeenMs) return { st:'미수신', cls:'off', age:'-' };
    const age = Math.max(0, Math.floor((Date.now()-lastSeenMs)/1000));
    const on = age <= ttlSec;
    return { st:on?'ONLINE':'OFFLINE', cls:on?'on':'off', age:String(age) };
  }

  async function refresh(){
    const base = normBase(apiBaseEl.value);
    if(!base){ metaEl.innerHTML = pill('Worker URL 입력', 'warn'); return; }

    metaEl.textContent = '불러오는 중...';
    tbodyEl.innerHTML = '';

    const stores = await loadStores();
    const [tv, ad] = await Promise.all([fetchStatus('tv', base), fetchStatus('admin', base)]);
    const tvMap = mapByStore(tv.items);
    const adMap = mapByStore(ad.items);

    const q = (qEl.value||'').trim().toLowerCase();
    const rows = stores.filter(s => !q || s.store.includes(q) || (s.name||'').toLowerCase().includes(q)).map(s => {
      const tvRec = tvMap.get(s.store);
      const adRec = adMap.get(s.store);
      const tvCalc = calc(toMs(tvRec?.lastSeen), tv.ttlSec);
      const adCalc = calc(toMs(adRec?.lastSeen), ad.ttlSec);
      return {
        ...s,
        tvCalc, adCalc,
        tvMeta: tvRec ? `${tvRec.ip||''}/${tvRec.colo||''}` : '-',
        adMeta: adRec ? `${adRec.ip||''}/${adRec.colo||''}` : '-',
      };
    });

    const tvOnline = rows.filter(r => r.tvCalc.cls==='on').length;
    const adOnline = rows.filter(r => r.adCalc.cls==='on').length;

    metaEl.innerHTML = `${pill('TV ONLINE '+tvOnline+'/'+rows.length,'on')} ${pill('ADMIN ONLINE '+adOnline+'/'+rows.length,'on')}
      <span class="small">TTL: TV ${tv.ttlSec}s / ADMIN ${ad.ttlSec}s · ${new Date().toLocaleString()}</span>`;

    tbodyEl.innerHTML = rows.map(r => `
      <tr>
        <td>${esc(r.name)}</td>
        <td class="mono">${esc(r.store)}</td>
        <td>${pill(r.tvCalc.st, r.tvCalc.cls)}</td>
        <td class="right mono">${esc(r.tvCalc.age)}</td>
        <td>${pill(r.adCalc.st, r.adCalc.cls)}</td>
        <td class="right mono">${esc(r.adCalc.age)}</td>
        <td class="mono small">${esc(r.tvMeta)}</td>
        <td class="mono small">${esc(r.adMeta)}</td>
      </tr>
    `).join('');
  }

  $("refreshBtn").onclick = refresh;
  [apiBaseEl, qEl].forEach(el => el.addEventListener('keyup', e => { if(e.key==='Enter') refresh(); }));

  refresh();
  setInterval(refresh, 10000);
})();
</script>
</body>
</html>


